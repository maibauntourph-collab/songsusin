# 모바일 가이드 시스템 문제 해결 보고서 (Troubleshooting Report)

## 1. 개요
본 문서는 안드로이드 및 모바일 환경에서 발생한 오디오 전송, STT(음성인식) 충돌, 그리고 Recorder 모드 오작동 문제를 해결한 과정과 결과를 정리합니다.

## 2. 발생했던 문제점 및 해결 방법

### 2.1. Recorder 모드에서 소리가 들리지 않는 문제 (Android)
*   **증상:** 가이드가 [Recorder Mode]를 켰음에도 여행객 폰에서는 "Waiting..." 상태이거나, 게이지는 움직이는데 소리가 안 들림.
*   **원인 (1): 코덱 불일치**
    *   안드로이드(Chrome/Samsung Internet)는 기본적으로 `audio/webm;codecs=opus`를 사용하는데, 수신측(여행객) 브라우저가 이 데이터의 초기 헤더(Init Packet)를 놓치거나 호환되지 않으면 재생을 거부함.
    *   아이폰(iOS)은 `audio/mp4`나 `AAC`를 사용하여 비교적 호환성이 좋음.
*   **원인 (2): 데이터 전송 간격 (Timeslice) 과소**
    *   기존 250ms 간격은 안드로이드 인코더에게 너무 짧아, 유효한 오디오 프레임이 생성되지 않고 빈 데이터만 전송되는 경우가 발생.
*   **원인 (3): 수신측의 엄격한 검사**
    *   여행객 코드가 "초기화 패킷(Init)"이 올 때까지 소리 재생을 막고 있었음.
*   **✅ 해결책:**
    1.  **코덱 우선순위 변경:** 안드로이드도 가능하다면 `audio/mp4`를 우선 사용하도록 설정.
    2.  **전송 간격 확대:** `recorder.start(1000)`으로 설정하여 1초마다 안정된 데이터 덩어리를 전송.
    3.  **재생 잠금 해제:** 여행객 폰에서 초기화 패킷 없이도 데이터가 들어오면 즉시 재생하도록 수정.
    4.  **MIME Type 자동 감지:** 수신측에서 `MediaSource.isTypeSupported`를 통해 브라우저가 지원하는 코덱으로 자동 연결.

### 2.2. STT 모드 "띠링" 소리 및 좀비 현상
*   **증상:** Recorder 모드로 바꿨는데도 계속 "띠링" 소리가 나거나 STT가 백그라운드에서 혼자 재시작됨.
*   **원인:** `recognition.onend` 이벤트가 모드 변경 여부를 제대로 인지하지 못하고 무조건 재시작함. 특히 `offlineMode`나 `audioMode` 변수가 비동기 상황에서 꼬임.
*   **✅ 해결책:**
    1.  **변수 강제 동기화:** `window.audioMode` 전역 변수를 사용하여 모드 상태를 확실하게 고정.
    2.  **재시작 차단 로직:** `onend` 발생 시 현재 모드가 'stt'가 아니거나 'offlineMode'이면 즉시 재시작을 중단 (`return`).
    3.  **오프라인 모드 로직:** 오프라인 체크박스 선택 시 STT 엔진을 명시적으로 `stop()` 호출.

### 2.3. 모드 전환 시 먹통 현상
*   **증상:** 방송 중에 입력을 바꾸면(STT ↔ Recorder) 아무 반응이 없음.
*   **원인:** 모드 변경 함수가 "변수 값"만 바꾸고, 실제 하드웨어(마이크/녹음기)를 껐다 켜는 로직이 빠져 있었음.
*   **✅ 해결책:** 방송 중 모드 변경 시, 즉시 이전 장치를 끄고 새로운 장치(Recorder 또는 STT)를 `start()` 하도록 동적 전환 로직 구현.

---

## 3. UI/UX 개선 사항 (요청 반영)
*   **디버그 로그 개선:** 최신 로그가 **항상 맨 위**에 나오도록 순서 변경.
*   **개발자 모드 정리:** 복잡한 디버깅 상태창은 [Developer] 모드일 때만 보이도록 숨김 처리.
*   **심플 모드 강화:** [Simple] 모드에서도 장소를 선택하고 안내(F)를 보낼 수 있도록 기능 노출.

## 4. 향후 관리 가이드
*   **Ubuntu 서버 업데이트:** `git pull` 명령어로 최신 코드 유지.
*   **안드로이드 테스트:** 크롬 브라우저 권장 (삼성 인터넷도 호환되나 크롬이 가장 안정적).
*   **오프라인 모드:** 인터넷이 없는 환경에서는 반드시 [Offline Mode] 체크박스를 켜서 STT 오류를 방지하세요.
…\mobile-guide-system > cat >> "c:\Users\tourm\OneDrive\문서\새 폴더\mobile-guide-system\논의.md" <<EOF

## 6. 안드로이드 STT '띠링' 비프음 제거 방안 (STT Beep Issue)
"가이드 폰에서 대기 중에 자꾸 '띠링' 소리가 나요."

*   **원인 (The Cause)**:
    *   안드로이드(Chrome/Google) 정책상 **음성 인식(STT)이 시작되고 끝날 때마다** 사생활 보호를 위해 강제로 시스템 비프음을 재생합니다. 
    *   현재 구조(Web Speech API)에서는 웹사이트 코드(\`app.js\`)로 이 소리를 끄는 것이 **불가능**합니다. (OS 레벨 강제 사항)

*   **현재 해결 방안 (Short-term Solution)**:
    1.  **[Recorder Mode] 적극 활용**: 
        *   방금 수정한 **[Recorder Mode]**를 사용하세요.
        *   Recorder 모드는 '녹음기' 방식이라 **'띠링' 소리가 절대 나지 않습니다.**
        *   단순 음성 방송만 필요할 때는 이 모드가 정답입니다.
    2.  **안드로이드 설정 변경 (기기별 상이)**:
        *   \`설정 > 접근성 > TalkBack > 설정 > 소리 및 진동 > 효과음\` 끄기.
        *   또는 \`설정 > 앱 > Google > 설정 > 음성\` 메뉴 확인.
        *   (하지만 최신 안드로이드는 이 설정으로도 비프음이 안 꺼지는 경우가 많습니다.)

*   **근본적인 해결 방안 (Long-term Solution - 아키텍처 변경)**:
    *   만약 "STT(자막/번역)도 쓰면서 소리는 없애고 싶다"면, 현재의 **클라이언트(폰) STT 방식**을 버리고 **서버 STT 방식**으로 변경해야 합니다.
    *   **클라이언트 STT (현재)**: 폰이 직접 듣고 텍스트로 변환 (무료, 끊길 때마다 소리 남).
    *   **서버 STT (변경안)**: 폰은 소리만 서버로 전송(소리 안 남) -> 서버가 OpenAI Whisper나 Google Cloud API로 변환.
    *   **단점**: 서버 비용 발생 (API 사용료) 및 고성능 서버 필요.
EOF